# é”™è¯¯å›é€€æœºåˆ¶åˆ†ææŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šäº†ä¸€ä¸ª400é”™è¯¯ï¼Œéœ€è¦ç¡®è®¤æ˜¯å¦ä¸ºä¸Šæ¸¸åç«¯è¿”å›ï¼Œå¹¶ç¡®ä¿æ­¤ç±»é”™è¯¯èƒ½è§¦å‘å›é€€æœºåˆ¶ã€‚

### åŸå§‹é”™è¯¯æ—¥å¿—

```json
{
  "level": "error",
  "timestamp": "2026-01-19T09:49:39.392+0800",
  "caller": "logging/factory.go:552",
  "msg": "é”™è¯¯æ—¥å¿—",
  "logger": "error",
  "reqID": "req_0d7bdd0ff1244d59_GROUP_1",
  "content": "================== é”™è¯¯æ—¥å¿— ==================\nè¯·æ±‚ID: req_0d7bdd0ff1244d59\næ—¶é—´: 2026-01-19T09:49:39+08:00\nåç«¯: GROUP_1\næ¨¡å‹: XAIO-C-4-5-Sonnet\nçŠ¶æ€ç : 400\n\n--- å“åº”å†…å®¹ ---\nevent: error data: {\"details\":\"{\\\"type\\\":\\\"error\\\",\\\"error\\\":{\\\"type\\\":\\\"invalid_request_error\\\",\\\"message\\\":\\\"This organization has been disabled.\\\"},\\\"request_id\\\":\\\"req_011CXFtybv84NUBEF4zAMDw1\\\"}\",\"error\":\"Claude API error\",\"status\":400,\"timestamp\":\"2026-01-19T01:49:39Z\"}\n"
}
```

## åˆ†æç»“æœ

### 1. é”™è¯¯æ¥æºç¡®è®¤

**ç»“è®ºï¼šè¿™æ˜¯ä¸Šæ¸¸Claude APIè¿”å›çš„é”™è¯¯**

**è¯æ®ï¼š**

- **è¯·æ±‚IDæ ¼å¼å·®å¼‚**
  - æˆ‘ä»¬ç³»ç»Ÿç”Ÿæˆçš„è¯·æ±‚IDï¼š`req_0d7bdd0ff1244d59`ï¼ˆå‰ç¼€ `req_` + 18ä½UUIDæˆªæ–­ï¼‰
  - å“åº”ä¸­çš„è¯·æ±‚IDï¼š`req_011CXFtybv84NUBEF4zAMDw1`ï¼ˆClaude APIçš„æ ¼å¼ï¼‰
  
- **é”™è¯¯æ¶ˆæ¯æ ¼å¼**
  - å“åº”é‡‡ç”¨SSEï¼ˆServer-Sent Eventsï¼‰æ ¼å¼ï¼š`event: error data: {...}`
  - å†…å±‚åŒ…å«Claude APIæ ‡å‡†é”™è¯¯ç»“æ„ï¼š
    ```json
    {
      "type": "error",
      "error": {
        "type": "invalid_request_error",
        "message": "This organization has been disabled."
      },
      "request_id": "req_011CXFtybv84NUBEF4zAMDw1"
    }
    ```

- **é”™è¯¯ç±»å‹**
  - `invalid_request_error` æ˜¯Claude APIçš„æ ‡å‡†é”™è¯¯ç±»å‹
  - é”™è¯¯æ¶ˆæ¯ "This organization has been disabled." è¡¨æ˜è¯¥APIå¯†é’¥æ‰€å±çš„ç»„ç»‡è´¦æˆ·å·²è¢«ç¦ç”¨

### 2. é”™è¯¯æ£€æµ‹æœºåˆ¶åˆ†æ

#### å½“å‰å®ç°ï¼ˆsrc/proxy/detector.goï¼‰

```go
func (d *Detector) ShouldFallback(statusCode int, body string) bool {
    // 1. æ£€æŸ¥HTTPçŠ¶æ€ç ï¼ˆæ”¯æŒç²¾ç¡®åŒ¹é…å’Œé€šé…ç¬¦ï¼‰
    for _, pattern := range errorCodes {
        if d.matchStatusCode(statusCode, pattern) {
            return true
        }
    }
    
    // 2. æ£€æŸ¥å“åº”ä½“ä¸­çš„é”™è¯¯æ¨¡å¼ï¼ˆç®€å•å­—ç¬¦ä¸²åŒ…å«åŒ¹é…ï¼‰
    for _, pattern := range cfg.Detection.ErrorPatterns {
        if strings.Contains(body, pattern) {
            return true
        }
    }
    
    return false
}
```

#### åŸé…ç½®ï¼ˆdist/config.yamlï¼‰

```yaml
detection:
  error_codes: ["4xx", "5xx"]
  error_patterns:
    - "insufficient_quota"
    - "rate_limit"
    - "exceeded"
    - "billing"
    - "quota"
```

#### é—®é¢˜åˆ†æ

è™½ç„¶ `error_codes: ["4xx"]` ç†è®ºä¸Šåº”è¯¥åŒ¹é…400çŠ¶æ€ç ï¼Œä½†åŸæœ‰çš„ `error_patterns` åˆ—è¡¨ä¸­**ç¼ºå°‘ç»„ç»‡è¢«ç¦ç”¨ç›¸å…³çš„é”™è¯¯æ¨¡å¼**ï¼Œå¯¼è‡´ï¼š

1. **çŠ¶æ€ç åŒ¹é…**ï¼š400 åŒ¹é… "4xx" âœ…
2. **é”™è¯¯æ¨¡å¼åŒ¹é…**ï¼šå“åº”ä½“ä¸åŒ…å« "insufficient_quota"ã€"rate_limit" ç­‰å·²é…ç½®çš„æ¨¡å¼ âŒ
3. **æœ€ç»ˆç»“æœ**ï¼šç”±äºçŠ¶æ€ç å·²åŒ¹é…ï¼Œåº”è¯¥ä¼šè§¦å‘å›é€€ï¼ˆéœ€è¦ç¡®è®¤æ˜¯å¦è¿˜æœ‰å…¶ä»–åç«¯å¯ç”¨ï¼‰

### 3. è§£å†³æ–¹æ¡ˆ

#### å·²å®æ–½çš„æ”¹è¿›

æ›´æ–°äº† `dist/config.yaml` ä¸­çš„é”™è¯¯æ£€æµ‹æ¨¡å¼ï¼Œæ–°å¢ä»¥ä¸‹åŒ¹é…è§„åˆ™ï¼š

```yaml
detection:
  error_codes: ["4xx", "5xx"]
  error_patterns:
    - "insufficient_quota"
    - "rate_limit"
    - "exceeded"
    - "billing"
    - "quota"
    - "has been disabled"           # ç»„ç»‡è¢«ç¦ç”¨é”™è¯¯
    - "invalid_request_error"       # Claude API æ— æ•ˆè¯·æ±‚é”™è¯¯
    - "authentication_error"        # è®¤è¯é”™è¯¯
    - "permission_error"            # æƒé™é”™è¯¯
    - "overloaded_error"            # è¿‡è½½é”™è¯¯
    - "api_error"                   # APIé€šç”¨é”™è¯¯
```

#### æ–°å¢æ¨¡å¼è¯´æ˜

| é”™è¯¯æ¨¡å¼ | åŒ¹é…åœºæ™¯ | ç¤ºä¾‹é”™è¯¯æ¶ˆæ¯ |
|---------|---------|-------------|
| `has been disabled` | ç»„ç»‡/è´¦æˆ·è¢«ç¦ç”¨ | "This organization has been disabled." |
| `invalid_request_error` | Claude APIæ— æ•ˆè¯·æ±‚ | "type": "invalid_request_error" |
| `authentication_error` | èº«ä»½è®¤è¯å¤±è´¥ | APIå¯†é’¥æ— æ•ˆæˆ–è¿‡æœŸ |
| `permission_error` | æƒé™ä¸è¶³ | ç¼ºå°‘è®¿é—®ç‰¹å®šèµ„æºçš„æƒé™ |
| `overloaded_error` | æœåŠ¡è¿‡è½½ | "The API is currently overloaded" |
| `api_error` | é€šç”¨APIé”™è¯¯ | å…¶ä»–æœªåˆ†ç±»çš„APIé”™è¯¯ |
| `upstream_all_accounts_busy` | ä¸Šæ¸¸è´¦å·å…¨å¿™ | "ä¸Šæ¸¸è´¦å·å…¨å¿™,è¯·ç¨åé‡è¯•" (code: upstream_all_accounts_busy) |
| `ç³»ç»Ÿç¹å¿™` | ä¸­æ–‡ç³»ç»Ÿç¹å¿™æç¤º | "ç³»ç»Ÿç¹å¿™,ä¸Šæ¸¸è´¦å·å…¨å¿™,è¯·ç¨åé‡è¯•" |
| `bad_request_error` | é”™è¯¯è¯·æ±‚ | "type": "bad_request_error" |
| `invalid params` | æ— æ•ˆå‚æ•° | "invalid params, invalid chat setting" |
| `invalid chat setting` | æ— æ•ˆèŠå¤©è®¾ç½® | MiniMaxç­‰æ¨¡å‹çš„å‚æ•°é…ç½®é”™è¯¯ |

### 4. å·¥ä½œæµç¨‹

å½“é‡åˆ°æ­¤ç±»é”™è¯¯æ—¶ï¼Œç³»ç»Ÿä¼šï¼š

1. **æ£€æµ‹é”™è¯¯**ï¼š`detector.ShouldFallback(400, responseBody)` è¿”å› `true`
2. **è¿›å…¥å†·å´**ï¼šå°†è¯¥åç«¯ï¼ˆGROUP_1/XAIO-C-4-5-Sonnetï¼‰åŠ å…¥å†·å´åˆ—è¡¨ï¼ˆé»˜è®¤120ç§’ï¼‰
3. **å°è¯•ä¸‹ä¸€ä¸ªåç«¯**ï¼šæŒ‰ç…§ä¼˜å…ˆçº§å°è¯•å…¶ä»–å¯ç”¨åç«¯
4. **L2è·¨æ¨¡å‹å›é€€**ï¼šå¦‚æœåŒæ¨¡å‹çš„æ‰€æœ‰åç«¯éƒ½å¤±è´¥ï¼Œä¼šè§¦å‘ `alias_fallback` é…ç½®çš„è·¨æ¨¡å‹å›é€€

#### é’ˆå¯¹ `anthropic/claude-sonnet-4-5` çš„å›é€€é“¾

```yaml
"anthropic/claude-sonnet-4-5":
  routes:
    - backend: "oocc"
      model: "claude-sonnet-4-5"
      priority: 1
      enabled: false          # å½“å‰ç¦ç”¨
    - backend: "GROUP_1"
      model: "XAIO-C-4-5-Sonnet"
      priority: 2             # å½“å‰ä¸»è¦åç«¯

# L2å›é€€é…ç½®
fallback:
  alias_fallback:
    "anthropic/claude-sonnet-4-5":
      - "google/gemini-3-pro-preview"
      - "minimax/minimax-m2.1"
```

## å»ºè®®

### 1. ç«‹å³è¡ŒåŠ¨

- âœ… **å·²å®Œæˆ**ï¼šæ·»åŠ ç»„ç»‡ç¦ç”¨é”™è¯¯åˆ°æ£€æµ‹æ¨¡å¼
- âš ï¸ **éœ€æ£€æŸ¥**ï¼šGROUP_1 åç«¯çš„APIå¯†é’¥æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
- ğŸ”„ **é‡å¯æœåŠ¡**ï¼šé…ç½®æ›´æ–°åéœ€é‡å¯æœåŠ¡æˆ–ç­‰å¾…çƒ­é‡è½½ç”Ÿæ•ˆ

### 2. ç›‘æ§å»ºè®®

å»ºè®®ç›‘æ§ä»¥ä¸‹é”™è¯¯æ¨¡å¼çš„å‡ºç°é¢‘ç‡ï¼š

- `has been disabled`ï¼šAPIå¯†é’¥æ‰€å±ç»„ç»‡è¢«ç¦ç”¨
- `insufficient_quota`ï¼šé…é¢ä¸è¶³
- `rate_limit`ï¼šé€Ÿç‡é™åˆ¶
- `authentication_error`ï¼šè®¤è¯å¤±è´¥

### 3. é•¿æœŸä¼˜åŒ–

1. **å¢å¼ºé”™è¯¯è§£æ**ï¼šè€ƒè™‘è§£æJSONå“åº”ä½“ï¼Œç²¾ç¡®æå– `error.type` å­—æ®µ
2. **åˆ†çº§é”™è¯¯å¤„ç†**ï¼šåŒºåˆ†å¯é‡è¯•é”™è¯¯ï¼ˆrate_limitï¼‰å’Œä¸å¯é‡è¯•é”™è¯¯ï¼ˆdisabledï¼‰
3. **å‘Šè­¦æœºåˆ¶**ï¼šå¯¹äº `has been disabled` ç­‰ä¸¥é‡é”™è¯¯ï¼Œåº”ç«‹å³å‘é€å‘Šè­¦é€šçŸ¥

## å‚è€ƒ

- é”™è¯¯æ£€æµ‹å®ç°ï¼š`src/proxy/detector.go`
- ä»£ç†ä¸»é€»è¾‘ï¼š`src/proxy/proxy.go:324-339`
- é…ç½®æ–‡ä»¶ï¼š`dist/config.yaml:192-205`

