# 日志级别调整说明

本文档记录了 llm-proxy 项目中的日志级别调整，以优化日志输出和可读性。

## 调整原则

- **ERROR**: 严重错误、系统故障、无法恢复的错误
- **WARN**: 可恢复的错误、异常情况、需要关注的非正常状态
- **INFO**: 重要业务事件、请求成功、关键操作完成
- **DEBUG**: 调试信息、详细的处理流程、中间状态
- **FileOnly**: 仅记录到文件的详细日志（如 SSE 数据块、错误检测详情等）

## 修改记录

### src/proxy/proxy.go

| 行号 | 原级别 | 新级别 | 日志内容 | 说明 |
|------|--------|--------|----------|------|
| 124 | Debug | FileOnlyDebug | 解析到可用路由 | 路由解析详情，仅文件记录 |
| 165 | Info | Debug | 尝试后端 | 每次重试后端，调试级别 |
| 289 | Info | Debug | 开始流式传输 | 流式传输开始，调试级别 |
| 292 | Info | Debug | 完成流式传输 | 流式传输完成，调试级别 |
| 330 | Info | Debug | 触发回退 | 回退操作，调试级别 |

### src/proxy/detector.go

| 行号 | 原级别 | 新级别 | 日志内容 | 说明 |
|------|--------|--------|----------|------|
| 28 | Debug | FileOnlyDebug | 开始错误检测 | 错误检测详情，仅文件记录 |
| 44 | Debug | FileOnlyDebug | 未匹配到任何错误规则,不触发回退 | 判断结果，仅文件记录 |

## 调整理由

1. **解析到可用路由 (proxy.go:124)**
   - 该日志包含路由解析的详细信息，对调试有用但过于频繁
   - 改为 FileOnly DEBUG，仅在需要时查看详细日志文件

2. **尝试后端 (proxy.go:165)**
   - 每次重试都会输出，在高并发场景下会产生大量日志
   - 降级为 DEBUG，正常生产环境不需要看到这些信息

3. **开始/完成流式传输 (proxy.go:289, 292)**
   - 流式传输是常见操作，不需要在 INFO 级别记录
   - 降级为 DEBUG，仅调试时关注

4. **触发回退 (proxy.go:330)**
   - 回退是故障转移的正常流程，不是错误
   - 降级为 DEBUG，避免在高故障率时刷屏

5. **错误检测详情 (detector.go:28, 44)**
   - 错误检测的详细信息对排查问题很有价值，但过于冗长
   - 改为 FileOnly DEBUG，保留详细信息但不影响主日志

## 未调整的日志

以下日志保持原级别，因为它们符合日志级别原则：

- **收到请求 (proxy.go:110)** - INFO：请求入口，重要业务事件
- **请求成功 (proxy.go:267)** - INFO：成功结果，需要监控
- **后端请求失败 (proxy.go:242)** - WARN：可恢复的错误
- **后端返回错误 (proxy.go:320)** - WARN：可恢复的错误
- **所有后端均失败 (proxy.go:345)** - ERROR：严重错误，需要关注
- **解析模型别名失败 (proxy.go:114)** - WARN：可恢复的错误
- **未知的模型别名 (proxy.go:119)** - WARN：配置问题
- **检测到错误状态码/模式 (detector.go:32, 39)** - INFO：重要的业务事件

## 建议

在生产环境中，建议配置：
- `level: "info"` - 文件日志级别
- `console_level: "info"` - 控制台日志级别

开发调试时，可以调整为：
- `level: "debug"` - 文件日志级别
- `console_level: "debug"` - 控制台日志级别

详细日志始终会记录到 `logs/proxy/verbose.log`，需要时可以查看。

