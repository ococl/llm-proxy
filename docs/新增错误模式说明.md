# 新增错误模式说明

## 错误1：上游账号全忙 (503错误)

### 原始日志
```json
{
  "level": "error",
  "timestamp": "2026-01-19T10:03:50.174+0800",
  "caller": "logging/factory.go:552",
  "msg": "错误日志",
  "logger": "error",
  "reqID": "req_082af74b29ba49ca_GROUP_1",
  "content": "================== 错误日志 ==================\n请求ID: req_082af74b29ba49ca\n时间: 2026-01-19T10:03:50+08:00\n后端: GROUP_1\n模型: XAIO-C-4-5-Sonnet\n状态码: 503\n\n--- 响应内容 ---\n{\"error\":{\"message\":\"系统繁忙,上游账号全忙,请稍后重试\",\"type\":\"server_error\",\"code\":\"upstream_all_accounts_busy\",\"param\":null,\"metadata\":{\"provider\":\"claude\"}}}\n"
}
```

### 错误分析
- **状态码**：503 (Service Unavailable)
- **错误类型**：`server_error`
- **错误代码**：`upstream_all_accounts_busy`
- **错误消息**：系统繁忙,上游账号全忙,请稍后重试
- **提供商**：claude

### 触发条件
当中间商（GROUP_1）的所有上游Claude账号都处于繁忙状态时触发此错误。这通常意味着：
1. 该中间商的账号池已达到并发上限
2. 所有账号都在处理其他请求
3. 需要等待或切换到其他后端

### 新增匹配模式
```yaml
- "upstream_all_accounts_busy"   # 精确匹配错误代码
- "系统繁忙"                      # 匹配中文错误消息
```

---

## 错误2：无效聊天设置 (400错误)

### 原始日志
```json
{
  "level": "error",
  "timestamp": "2026-01-19T10:03:52.238+0800",
  "caller": "logging/factory.go:552",
  "msg": "错误日志",
  "logger": "error",
  "reqID": "req_082af74b29ba49ca_GROUP_1",
  "content": "================== 错误日志 ==================\n请求ID: req_082af74b29ba49ca\n时间: 2026-01-19T10:03:52+08:00\n后端: GROUP_1\n模型: MiniMax-M2.1\n状态码: 400\n\n--- 响应内容 ---\n{\"type\":\"error\",\"error\":{\"type\":\"bad_request_error\",\"message\":\"invalid params, invalid chat setting (2013)\",\"http_code\":\"400\"},\"request_id\":\"05bcc40802dba81ddec8353182c801c8\"}\n"
}
```

### 错误分析
- **状态码**：400 (Bad Request)
- **错误类型**：`bad_request_error`
- **错误消息**：invalid params, invalid chat setting (2013)
- **模型**：MiniMax-M2.1
- **请求ID**：05bcc40802dba81ddec8353182c801c8 (上游生成)

### 触发条件
这是一个参数配置错误，可能原因：
1. 请求参数格式不符合MiniMax API规范
2. 某些字段值超出允许范围
3. 必填参数缺失或格式错误
4. 模型不支持某些特定参数组合

### 问题根源
该错误出现在尝试切换到 `MiniMax-M2.1` 模型时，说明：
- 第一次尝试的 `XAIO-C-4-5-Sonnet` 失败（上游账号全忙）
- 系统触发回退，尝试 MiniMax 模型
- 但请求体参数可能针对Claude格式，导致MiniMax无法处理

### 新增匹配模式
```yaml
- "bad_request_error"       # 匹配错误类型
- "invalid params"          # 匹配无效参数提示
- "invalid chat setting"    # 匹配具体错误原因
```

---

## 回退链分析

根据配置文件 `dist/config.yaml`，该请求的回退链如下：

```yaml
"anthropic/claude-sonnet-4-5":
  routes:
    - backend: "oocc"
      model: "claude-sonnet-4-5"
      priority: 1
      enabled: false          # ❌ 已禁用
    
    - backend: "GROUP_1"
      model: "XAIO-C-4-5-Sonnet"
      priority: 2             # ✓ 第一次尝试
                              # ❌ 失败：上游账号全忙
```

### L2 跨模型回退
```yaml
fallback:
  alias_fallback:
    "anthropic/claude-sonnet-4-5":
      - "google/gemini-3-pro-preview"
      - "minimax/minimax-m2.1"    # ✓ 第二次尝试
                                   # ❌ 失败：参数不兼容
```

### 实际执行顺序
1. **尝试 1**：GROUP_1 / XAIO-C-4-5-Sonnet → 503 上游账号全忙
2. **触发回退**：检测到 `upstream_all_accounts_busy`，进入冷却
3. **尝试 2**：GROUP_1 / MiniMax-M2.1 → 400 参数不兼容
4. **触发回退**：检测到 `invalid chat setting`，进入冷却
5. **继续回退**：应该尝试下一个模型...

---

## 建议措施

### 1. 立即措施
✅ **已完成**：添加以下错误模式到配置
```yaml
detection:
  error_patterns:
    - "upstream_all_accounts_busy"
    - "系统繁忙"
    - "bad_request_error"
    - "invalid params"
    - "invalid chat setting"
```

### 2. 参数兼容性问题
⚠️ **需要关注**：跨模型回退时的参数转换

当从Claude模型回退到MiniMax时，某些Claude特有的参数可能不被MiniMax支持：
- `anthropic_version`
- `system` 字段处理方式不同
- `stop_sequences` 格式差异
- 其他特定参数

**建议方案**：
1. 在 `src/proxy/proxy.go` 中添加参数清理逻辑
2. 根据目标后端类型，过滤/转换不兼容的参数
3. 或者在配置中标记模型兼容性，避免不兼容的回退

### 3. 优先级调整建议
考虑调整回退链，优先选择兼容性更好的模型：

```yaml
fallback:
  alias_fallback:
    "anthropic/claude-sonnet-4-5":
      - "anthropic/claude-haiku-4-5"    # 同系列模型，兼容性好
      - "google/gemini-3-pro-preview"   # OpenAI格式兼容
      - "minimax/minimax-m2.1"          # 最后尝试
```

### 4. 监控指标
建议增加以下监控：
- `upstream_all_accounts_busy` 出现频率 → 可能需要增加账号池
- `invalid chat setting` 出现频率 → 参数兼容性问题
- 跨模型回退成功率 → 评估回退链有效性

---

## 更新记录

- **2026-01-19 10:10**：添加 `upstream_all_accounts_busy` 和 `系统繁忙` 匹配模式
- **2026-01-19 10:10**：添加 `bad_request_error`、`invalid params`、`invalid chat setting` 匹配模式
- **状态**：配置已更新，需重启服务生效

