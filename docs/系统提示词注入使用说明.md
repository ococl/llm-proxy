# 系统提示词注入使用说明

## 概述

LLM Proxy 支持从本地文件注入系统提示词到 API 请求中。这允许你在不修改客户端代码的情况下，为所有请求添加统一的系统指令。

## 快速开始

在可执行文件同目录下创建 `system_prompt.md` 文件：

```markdown
position: before
---

你是一个专业的编程助手。当前操作系统是 ${_OS}。
```

重启代理后，所有请求都会自动注入这段系统提示词。

## 文件格式

### 基本格式

```
[YAML 配置]
---
[提示词内容]
```

- 配置部分使用 YAML 格式
- 使用 `---` 分隔配置和内容
- 如果没有 `---`，整个文件作为提示词内容

### 配置字段

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `position` | string | `before` | 注入位置：`before`（前）或 `after`（后） |
| `separator` | string | `double-newline` | 分隔符：`newline`、`double-newline`、`none`、`custom` |
| `custom_separator` | string | `""` | 当 `separator` 为 `custom` 时使用 |
| `models` | []string | `["*"]` | 模型匹配规则，支持通配符 |
| `enabled` | bool | `true` | 是否启用 |
| `priority` | int | `100` | 加载优先级（数值小的优先） |

### 示例

```markdown
position: before
separator: double-newline
models: ["claude-*", "gpt-4*"]
enabled: true
---

## 当前环境
- 操作系统: ${_OS} (${_ARCH})
- Shell: ${_SHELL}
- 当前时间: ${_DATETIME}

请根据操作系统选择合适的命令格式。
```

## 多文件支持

除了单个 `system_prompt.md` 文件，还支持 `system_prompts/` 目录：

```
可执行文件目录/
├── system_prompt.md           # 单文件（可选）
└── system_prompts/            # 多文件目录（可选）
    ├── 01_base.md
    ├── 02_security.md
    └── 03_coding.md
```

### 加载顺序

1. 按 `priority` 字段排序（数值小的优先）
2. 相同 priority 按文件名字母排序
3. 每个文件独立配置，独立判断是否注入

## 内置变量

使用 `${_变量名}` 语法引用内置变量：

### 系统信息

| 变量 | 示例值 | 说明 |
|------|--------|------|
| `${_OS}` | `windows` / `linux` / `darwin` | 操作系统 |
| `${_ARCH}` | `amd64` / `arm64` | CPU 架构 |
| `${_HOSTNAME}` | `my-laptop` | 主机名 |
| `${_USER}` | `john` | 当前用户名 |
| `${_HOME}` | `/home/john` | 用户主目录 |

### 开发环境

| 变量 | 示例值 | 说明 |
|------|--------|------|
| `${_SHELL}` | `bash` / `zsh` / `powershell` / `cmd` | 当前 Shell |
| `${_LANG}` | `zh_CN.UTF-8` | 系统语言 |

### 时间

| 变量 | 示例值 | 说明 |
|------|--------|------|
| `${_DATE}` | `2026-01-13` | 当前日期 |
| `${_TIME}` | `14:30:00` | 当前时间 |
| `${_DATETIME}` | `2026-01-13T14:30:00` | ISO 格式时间戳 |

## 环境变量

支持引用系统环境变量：

```
${VAR}              # 引用环境变量，不存在则为空
${VAR:-default}     # 引用环境变量，不存在则使用默认值
```

示例：
```markdown
---

当前项目: ${PROJECT_NAME:-未知项目}
API 密钥: ${API_KEY}
```

## 注入位置说明

### position: before

注入内容放在原 system message **前面**：

```
[注入内容] + [分隔符] + [原有 system message]
```

### position: after

注入内容放在原 system message **后面**：

```
[原有 system message] + [分隔符] + [注入内容]
```

## 模型匹配

使用通配符匹配模型名称：

| 模式 | 匹配示例 |
|------|----------|
| `*` | 所有模型 |
| `claude-*` | claude-3-opus, claude-3-sonnet |
| `gpt-4*` | gpt-4, gpt-4-turbo, gpt-4o |

示例：只对 Claude 模型启用

```markdown
models: ["claude-*"]
---

你是 Claude 助手的增强版本。
```

## 常见用例

### 1. 环境感知提示词

```markdown
---

当前环境信息：
- 操作系统: ${_OS}
- 架构: ${_ARCH}
- Shell: ${_SHELL}

请根据以上环境信息选择合适的命令和脚本格式。
```

### 2. 多语言支持

```markdown
---

用户系统语言: ${_LANG}
如果语言代码以 zh 开头，请使用中文回复。
```

### 3. 按模型定制

为不同模型创建不同配置文件：

**system_prompts/claude.md**
```markdown
models: ["claude-*"]
priority: 10
---

作为 Claude，请保持友好和专业的对话风格。
```

**system_prompts/gpt.md**
```markdown
models: ["gpt-*"]
priority: 10
---

作为 GPT，请提供详细和结构化的回答。
```
