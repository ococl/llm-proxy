{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://platform.openai.com/docs/api-reference/chat",
  "title": "OpenAI Chat Completion API Request/Response Schema",
  "description": "OpenAI Chat Completion API 的请求和响应 JSON Schema 定义",
  "type": "object",
  
  "definitions": {
    "message_role": {
      "type": "string",
      "enum": ["system", "user", "assistant", "tool", "developer"],
      "description": "消息的角色类型"
    },
    
    "message_content": {
      "oneOf": [
        {
          "type": "string",
          "description": "简单的文本内容"
        },
        {
          "type": "array",
          "description": "多模态内容块",
          "items": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": ["text", "image_url"],
                "description": "内容块类型"
              },
              "text": {
                "type": "string",
                "description": "文本内容（type=text 时）"
              },
              "image_url": {
                "type": "object",
                "properties": {
                  "url": {
                    "type": "string",
                    "format": "uri",
                    "description": "图片 URL（支持 data: 或 https: 协议）"
                  },
                  "detail": {
                    "type": "string",
                    "enum": ["auto", "low", "high"],
                    "default": "auto",
                    "description": "图片详细程度"
                  }
                },
                "required": ["url"]
              }
            },
            "required": ["type"]
          }
        }
      ]
    },
    
    "message": {
      "type": "object",
      "properties": {
        "role": {
          "$ref": "#/definitions/message_role"
        },
        "content": {
          "$ref": "#/definitions/message_content"
        },
        "name": {
          "type": "string",
          "description": "可选的消息发送者名称"
        },
        "function_call": {
          "type": "object",
          "properties": {
            "name": {
              "type": "string",
              "description": "要调用的函数名称"
            },
            "arguments": {
              "type": "string",
              "description": "函数的参数（JSON 字符串）"
            }
          },
          "required": ["name", "arguments"]
        },
        "tool_calls": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": {
                "type": "string",
                "description": "工具调用 ID"
              },
              "type": {
                "type": "string",
                "enum": ["function"],
                "description": "工具类型"
              },
              "function": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "要调用的函数名称"
                  },
                  "arguments": {
                    "type": "string",
                    "description": "函数的参数（JSON 字符串）"
                  }
                },
                "required": ["name"]
              }
            },
            "required": ["id", "type", "function"]
          }
        },
        "tool_call_id": {
          "type": "string",
          "description": "工具调用 ID（tool 角色消息使用）"
        },
        "refusal": {
          "type": "string",
          "description": "模型拒绝回答的原因"
        },
        "annotations": {
          "type": "array",
          "description": "内容注释（如引用）",
          "items": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": ["url_citation", "text_citation"]
              },
              "url_citation": {
                "type": "object",
                "properties": {
                  "url": {
                    "type": "string",
                    "format": "uri"
                  },
                  "title": {
                    "type": "string"
                  }
                }
              },
              "text_citation": {
                "type": "object",
                "properties": {
                  "document_id": {
                    "type": "string"
                  }
                }
              }
            }
          }
        }
      },
      "required": ["role", "content"]
    },
    
    "response_message": {
      "type": "object",
      "properties": {
        "role": {
          "$ref": "#/definitions/message_role"
        },
        "content": {
          "type": ["string", "null"],
          "description": "助手回复的内容"
        },
        "tool_calls": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/message/properties/tool_calls/items"
          }
        },
        "function_call": {
          "$ref": "#/definitions/message/properties/function_call"
        },
        "refusal": {
          "type": ["string", "null"]
        },
        "annotations": {
          "type": "array"
        }
      },
      "required": ["role"]
    },
    
    "choice": {
      "type": "object",
      "properties": {
        "index": {
          "type": "integer",
          "description": "选择的索引（当 n > 1 时）"
        },
        "message": {
          "$ref": "#/definitions/response_message"
        },
        "logprobs": {
          "oneOf": [
            {
              "type": "null"
            },
            {
              "type": "object",
              "properties": {
                "content": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "token": {
                        "type": "string"
                      },
                      "logprob": {
                        "type": "number"
                      },
                      "bytes": {
                        "type": "array",
                        "items": {
                          "type": "integer"
                        }
                      },
                      "top_logprobs": {
                        "type": "array",
                        "items": {
                          "type": "object",
                          "properties": {
                            "token": {
                              "type": "string"
                            },
                            "logprob": {
                              "type": "number"
                            },
                            "bytes": {
                              "type": "array",
                              "items": {
                                "type": "integer"
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          ]
        },
        "finish_reason": {
          "type": "string",
          "enum": ["stop", "length", "tool_calls", "content_filter", "function_call", "refusal"],
          "description": "完成原因"
        }
      },
      "required": ["index", "message", "finish_reason"]
    },
    
    "usage": {
      "type": "object",
      "properties": {
        "prompt_tokens": {
          "type": "integer",
          "description": "提示词消耗的 token 数量"
        },
        "completion_tokens": {
          "type": "integer",
          "description": "完成消耗的 token 数量"
        },
        "total_tokens": {
          "type": "integer",
          "description": "总消耗的 token 数量"
        },
        "prompt_tokens_details": {
          "type": "object",
          "properties": {
            "cached_tokens": {
              "type": "integer",
              "description": "缓存的提示词 token"
            },
            "audio_tokens": {
              "type": "integer",
              "description": "音频 token 数量"
            }
          }
        },
        "completion_tokens_details": {
          "type": "object",
          "properties": {
            "reasoning_tokens": {
              "type": "integer",
              "description": "推理 token 数量"
            },
            "audio_tokens": {
              "type": "integer",
              "description": "音频 token 数量"
            },
            "accepted_prediction_tokens": {
              "type": "integer"
            },
            "rejected_prediction_tokens": {
              "type": "integer"
            }
          }
        }
      },
      "required": ["prompt_tokens", "completion_tokens", "total_tokens"]
    },
    
    "stream_choice": {
      "type": "object",
      "properties": {
        "index": {
          "type": "integer"
        },
        "delta": {
          "type": "object",
          "properties": {
            "role": {
              "$ref": "#/definitions/message_role"
            },
            "content": {
              "type": ["string", "null"]
            },
            "tool_calls": {
              "type": "array"
            },
            "function_call": {
              "type": "object"
            }
          }
        },
        "logprobs": {
          "type": ["object", "null"]
        },
        "finish_reason": {
          "type": ["string", "null"]
        }
      },
      "required": ["index"]
    }
  },
  
  "properties": {
    "request": {
      "type": "object",
      "description": "Chat Completion API 请求",
      "properties": {
        "model": {
          "type": "string",
          "description": "要使用的模型 ID，如 gpt-4o、gpt-4o-mini 等"
        },
        "messages": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/message"
          },
          "description": "对话消息列表"
        },
        "frequency_penalty": {
          "type": "number",
          "minimum": -2.0,
          "maximum": 2.0,
          "default": 0,
          "description": "频率惩罚，用于减少重复 token"
        },
        "logit_bias": {
          "type": "object",
          "description": "Token 概率偏置"
        },
        "logprobs": {
          "type": "boolean",
          "default": false,
          "description": "是否返回 log probabilities"
        },
        "top_logprobs": {
          "type": "integer",
          "minimum": 0,
          "maximum": 20,
          "description": "返回 top n 个 log probabilities"
        },
        "max_tokens": {
          "type": "integer",
          "description": "最大生成 token 数（已弃用，推荐使用 max_completion_tokens）"
        },
        "max_completion_tokens": {
          "type": "integer",
          "description": "最大完成 token 数"
        },
        "metadata": {
          "type": "object",
          "description": "自定义元数据（最多 16 个键值对）"
        },
        "modalities": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["text", "audio"]
          },
          "description": "输出类型"
        },
        "n": {
          "type": "integer",
          "minimum": 1,
          "maximum": 128,
          "default": 1,
          "description": "生成的选择数量"
        },
        "presence_penalty": {
          "type": "number",
          "minimum": -2.0,
          "maximum": 2.0,
          "default": 0,
          "description": "存在惩罚，用于鼓励新话题"
        },
        "response_format": {
          "type": "object",
          "description": "响应格式控制",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["text", "json_object", "json_schema"]
            },
            "json_schema": {
              "type": "object",
              "description": "JSON Schema 定义（type=json_schema 时）"
            },
            "strict": {
              "type": "boolean",
              "description": "是否严格遵循 schema（type=json_schema 时）"
            }
          }
        },
        "seed": {
          "type": "integer",
          "description": "随机种子，用于尝试确定性采样"
        },
        "service_tier": {
          "type": "string",
          "enum": ["auto", "default", "flex", "priority"],
          "default": "auto",
          "description": "服务层级"
        },
        "stop": {
          "oneOf": [
            {
              "type": "string"
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            {
              "type": "null"
            }
          ],
          "description": "停止序列"
        },
        "store": {
          "type": "boolean",
          "default": false,
          "description": "是否存储此请求用于模型蒸馏或评估"
        },
        "stream": {
          "type": "boolean",
          "default": false,
          "description": "是否启用流式响应"
        },
        "stream_options": {
          "type": "object",
          "description": "流式响应选项",
          "properties": {
            "include_usage": {
              "type": "boolean",
              "description": "是否在最后包含 usage 信息"
            }
          }
        },
        "temperature": {
          "type": "number",
          "minimum": 0,
          "maximum": 2,
          "default": 1,
          "description": "采样温度"
        },
        "tool_choice": {
          "oneOf": [
            {
              "type": "string",
              "enum": ["none", "auto", "required"]
            },
            {
              "type": "object",
              "properties": {
                "type": {
                  "type": "string",
                  "enum": ["function"]
                },
                "function": {
                  "type": "object",
                  "properties": {
                    "name": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          ],
          "description": "工具选择控制"
        },
        "tools": {
          "type": "array",
          "description": "可用工具列表",
          "items": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": ["function"]
              },
              "function": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string"
                  },
                  "description": {
                    "type": "string"
                  },
                  "parameters": {
                    "type": "object",
                    "description": "JSON Schema 格式的参数定义"
                  },
                  "strict": {
                    "type": "boolean"
                  }
                },
                "required": ["name"]
              }
            },
            "required": ["type", "function"]
          }
        },
        "top_p": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "default": 1,
          "description": "核采样参数"
        },
        "user": {
          "type": "string",
          "description": "终端用户标识（已弃用，推荐使用 safety_identifier）"
        },
        "parallel_tool_calls": {
          "type": "boolean",
          "default": true,
          "description": "是否允许并行工具调用"
        },
        "prediction": {
          "type": "object",
          "description": "预测输出配置",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["content"]
            },
            "content": {
              "type": "string",
              "description": "预测的输出内容"
            }
          }
        },
        "reasoning_effort": {
          "type": "string",
          "enum": ["none", "minimal", "low", "medium", "high", "xhigh"],
          "description": "推理努力程度（推理模型专用）"
        },
        "safety_identifier": {
          "type": "string",
          "description": "安全标识符"
        },
        "prompt_cache_key": {
          "type": "string",
          "description": "提示缓存键"
        },
        "prompt_cache_retention": {
          "type": "string",
          "description": "提示缓存保留时间"
        },
        "verbosity": {
          "type": "string",
          "enum": ["low", "medium", "high"],
          "description": "响应详细程度"
        },
        "web_search_options": {
          "type": "object",
          "description": "网络搜索选项"
        }
      },
      "required": ["model", "messages"]
    },
    
    "response": {
      "type": "object",
      "description": "Chat Completion API 非流式响应",
      "properties": {
        "id": {
          "type": "string",
          "description": "完成 ID"
        },
        "object": {
          "type": "string",
          "enum": ["chat.completion"],
          "description": "对象类型"
        },
        "created": {
          "type": "integer",
          "description": "创建时间戳（Unix 秒）"
        },
        "model": {
          "type": "string",
          "description": "使用的模型"
        },
        "system_fingerprint": {
          "type": "string",
          "description": "后端配置指纹"
        },
        "choices": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/choice"
          }
        },
        "usage": {
          "$ref": "#/definitions/usage"
        },
        "service_tier": {
          "type": "string",
          "description": "服务层级"
        }
      },
      "required": ["id", "object", "created", "model", "choices"]
    },
    
    "stream_response": {
      "type": "object",
      "description": "Chat Completion API 流式响应（单个 chunk）",
      "properties": {
        "id": {
          "type": "string",
          "description": "完成 ID"
        },
        "object": {
          "type": "string",
          "enum": ["chat.completion.chunk"],
          "description": "对象类型"
        },
        "created": {
          "type": "integer",
          "description": "创建时间戳（Unix 秒）"
        },
        "model": {
          "type": "string",
          "description": "使用的模型"
        },
        "system_fingerprint": {
          "type": "string"
        },
        "choices": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/stream_choice"
          }
        },
        "usage": {
          "$ref": "#/definitions/usage",
          "description": "仅在最后 chunk 包含"
        }
      }
    }
  }
}
